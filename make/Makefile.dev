DOCKER_REPO?=quay.io/openshiftio
IMAGE_NAME?=git-service
SHORT_COMMIT=$(shell git rev-parse --short HEAD)
ifneq ($(GITUNTRACKEDCHANGES),)
SHORT_COMMIT := $(SHORT_COMMIT)-dirty
endif

TIMESTAMP:=$(shell date +%s)
TAG?=$(SHORT_COMMIT)-$(TIMESTAMP)

DEPLOY_DIR:=deploy

.PHONY: create-resources
create-resources:
	@echo "Logging using system:admin..."
	@oc login -u system:admin
	@echo "Creating sub resources..."
	@echo "Creating CRDs..."
	@oc create -f https://raw.githubusercontent.com/redhat-developer/devopsconsole-operator/master/deploy/crds/devopsconsole_v1alpha1_gitsource_crd.yaml
	@echo "Creating Namespace"
	@oc create -f $(DEPLOY_DIR)/namespace.yaml
	@echo "oc project codeready-devconsole"
	@oc project codeready-devconsole
	@echo "Creating Service Account"
	@oc create -f $(DEPLOY_DIR)/service_account.yaml
	@echo "Granting system:auth-delegator Role"
	@oc create -f $(DEPLOY_DIR)/grant-auth-delegator.yaml -n kube-system
	@echo "Granting extension-apiserver-authentication-reader Role"
	@oc create -f $(DEPLOY_DIR)/grant-auth-reader.yaml -n kube-system
	@echo "Granting Cluster Admin Role"
	@oc create -f $(DEPLOY_DIR)/grant-cluster-admin.yaml

.PHONY: create-cr
create-cr:
	@echo "Creating Custom Resource..."

.PHONY: build-image
build-image:
	docker build -t $(DOCKER_REPO)/$(IMAGE_NAME):$(TAG) -f Dockerfile.dev .
	docker tag $(DOCKER_REPO)/$(IMAGE_NAME):$(TAG) $(DOCKER_REPO)/$(IMAGE_NAME):test

.PHONY: deploy-apiserver-only
deploy-apiserver-only:
	@echo "Creating Replication Controller for API Server"
	@cat minishift/replication_controller.yaml | sed s/\:dev/:$(TAG)/ | oc create -f -
	@echo "Creating Service"
	@oc create -f $(DEPLOY_DIR)/service.yaml
	@echo "Creating API Service"
	@oc create -f $(DEPLOY_DIR)/apiservice.yaml

.PHONY: clean-all
clean-all:  clean-apiserver clean-resources

.PHONY: clean-apiserver
clean-apiserver:
	@echo "Deleting Replication Controller for API Server"
	@cat minishift/replication_controller.yaml | sed s/\:dev/:$(TAG)/ | oc delete -f - || true
	@echo "Deleting Service"
	@oc delete -f $(DEPLOY_DIR)/service.yaml || true
	@echo "Deleting API Service"
	@oc delete -f $(DEPLOY_DIR)/apiservice.yaml || true

.PHONY: clean-resources
clean-resources:
	@echo "Deleting sub resources..."
	@echo "Deleting Cluster Admin Role"
	@oc delete -f $(DEPLOY_DIR)/grant-cluster-admin.yaml || true
	@echo "Deleting extension-apiserver-authentication-reader Role"
	@oc delete -f $(DEPLOY_DIR)/grant-auth-reader.yaml -n kube-system || true
	@echo "Deleting system:auth-delegator Role"
	@oc delete -f $(DEPLOY_DIR)/grant-auth-delegator.yaml -n kube-system || true
	@echo "Deleting Service Account"
	@oc delete -f $(DEPLOY_DIR)/service_account.yaml || true
	@echo "Deleting Namespace"
	@oc delete -f $(DEPLOY_DIR)/namespace.yaml || true
	@echo "Deleting CRDs..."
	@oc delete -f https://raw.githubusercontent.com/redhat-developer/devopsconsole-operator/master/deploy/crds/devopsconsole_v1alpha1_gitsource_crd.yaml || true

.PHONY: deploy-apiserver
deploy-apiserver: build build-image deploy-apiserver-only

.PHONY: minishift-start
minishift-start:
	minishift start --cpus 4 --memory 8GB
	-eval `minishift docker-env` && oc login -u system:admin

.PHONY: deploy-all
deploy-all: clean-resources create-resources deps prebuild-check deploy-apiserver create-cr
